# Проектирование высоконагруженной социальнной сети фото-хостинга

Курсовая работа в рамках 3-го семестра программы по Веб-разработке ОЦ VK x МГТУ им. Н.Э. Баумана (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных сервисов"

#### Автор - [Чинаев Алексей](https://park.vk.company/profile/a.chinaev/ "Страница на портале VK x МГТУ")
#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчёт нагрузки](#2)


## Часть 1. Тема, функционал и аудитория <a name="1"></a>

### Тема курсовой работы - **"Проектирование высоконагруженной социальной сети фото-хостинга"**
В качестве примера и аналога выбрана социальная сеть [Pinterest](https://ru.pinterest.com/)

### Ключевой функционал сервиса
- Регистрация и авторизация пользователей
- Создание пинов
- Создание коллекций (досок) и сохранение в них пинов
- Бесконечная лента
- Комментарии к пинам
- Лайки к пинам

### Ключевые продуктовые решения
- Сочетание фото и видео в одной ленте для увеличения разнообразия контента
- Составление ленты и тематических подборок на основе действий пользователя
- Поиск по ключевым словам
- Рекламные алгоритмы

### Целевая аудитория
- 498 млн активных пользователей по всему миру [[1]](https://business.pinterest.com/audience/)
- 1,5 миллиарда пинов сохраняется каждую неделю [[2]](https://newsroom.pinterest.com/company/)

## Часть 2. Расчёт нагрузки <a name="2"></a>

### Продуктовые метрики

- MAU - 498 млн пользователей [[3]](https://business.pinterest.com/audience/)
- DAU - 80,5 млн пользователей [[4]](https://www.businessdit.com/social-media-statistics/)

#### Средний размер харанилища пользователя по типам:

| Хранимые данные   | Оценочный размер на пользователя         |
|-------------------|------------------------------------------|
| Аватары              | `1 Мб`                            |
| Данные профиля              | `1 Кб`                     |

**Таким образом всего:** `1 Мб 1Кб` на пользователя при регистрации и вводе персональных данных.

#### Среднее количество действий пользователя по типам в день

|Действие пользователя |Количество / день|
| ------------- |-------------|
|Регистрация|134,25 тыс|
|Авторизация|1,341 млн|
|Создание пинов|322 млн|
|Сохранение пинов|214,3 млн|
|Создание досок|2,87 млн|
|Просмотр пинов|4,025 млрд|
|Комментирование| 402,5 млн|
|Реакции|805 млн|

- За 2023 год аудитория Pinterest возросла на 49 млн [[5]](https://www.statista.com/statistics/463353/pinterest-global-mau/), т.е. в день в среднем регистрировались 134,25 тыс раз.  
- Пусть авторизацию в среднем проходят 6 раза в год => 1,341 млн раз в день.
- Ввиду отсутвия информации о среднем кол-ве создаваемых пинов возьмём среднее от рекомендуемого количества (5-10 [[6]](https://community.pinterest.biz/t5/connect-and-share-with-other-creators/how-many-pins-per-day/td-p/30848)),
  т.е. 7 пинов в день. Однако обычный пользователь очень редко выгружает пины, этим занимаются юр лица, поэтому будем считать, что одним пользователем выгружается 4 пинов/день.
  Тогда всего в день выгружается 322 млн пинов
- В неделю сохраняется 1,5 млрд. пинов [[7]](https://newsroom.pinterest.com/company/) => 214,3 млн/день
- Пусть пользователь создаёт 1 доску в месяц => всего пользователи создают 2,87 млн/день
- Пусть пользователь просматривает 50 пинов в день => всего 4,025 млрд/день
- Пользователь оставляет 5 комментариев в день => всего 402,5 млн/день
- И 10 реакций в день => всего 805 млн/день

### Технические метрики

#### Средний размер харанилища пользователя по типам:
|Хранилище |Стартовый размер (Пб)|Увеличение (Пб/год)|
| ------------- |-------------|-------------|
|Пины |271,39|271,39|
|Данные пользователя |0,033|0,022|
|Данные пользователя |0,039|0,039|

- Учитывая скорость создания пинов 322 млн/день из пункта выше, в год создаётся 117,5 млрд пинов.  
Макс размер пина 20 мб [[6]](https://ru.pinterest.com/pin-creation-tool/), средний 2 Мб (т.к. обычно загружаются небольшие изображения).  
Для видео 200 мб [[7]](https://ru.pinterest.com/pin-creation-tool/), средний 50 Мб (т.к. обычно загружаются небольшие видео). .  
99% пинов - изображения [[8]](https://buffer.com/resources/pinterest-marketing-study/).  
Тогда:

```azure
117,5 * 10^9 * (2 Мб * 0,99 + 0,01 * 50 Мб) ≈ 271,39 Пб
```
- Из пункта выше: необходимо `1 Мб 1Кб` на пользователя.  
Средний прирост пользователей за год 350,75 млн [[9]](https://www.bankmycell.com/blog/number-of-pinterest-users/).  
Тогда:

```azure
350,75 * 10^6 * 1025 Кб ≈ 0,033 Пб
```
Пусть прирост будет составлять 2/3 от начального значаения, т.к. многие пользователи не устанавливают аватарки.

- Максимальная длинна комментария 500 символов Unicode. Пусть средняя длина будет 150, т.к. в основном пишутся короткие комментарии.
Тогда 1 комментарий займёт 300 байт. Учитывая скорость комментирования из пункта выше - 402,5 млн/день. За год будет 147 млрд.
Тогда:

```azure
147 * 10^9 * 300 б ≈ 0,039 Пб
```
### Сетевой трафик и rps

#### RPS по типам запросов:
| Тип запроса | RPD   | RPS |
|-------------|-------------------------|-------------------------| 
|Регистрация|134,25 тыс|1,55|
|Авторизация|1,341 млн|15,52|
|Создание пинов|322 млн|3727|
|Сохранение пинов|214,3 млн|2480,3|
|Создание досок|2,87 млн|33,22|
|Просмотр пинов|4,025 млрд|46585,65|
|Комментирование|402,5 млн|4685,6|
|Реакции|805 млн|9317,13|

#### Сетевой трафик

**Пиковое потребление в течение суток (Гбит/с) по типам трафика:**
| Тип трафика        | Пиковое потребление, Тбит/с       | Суммарный суточный трафик, Пб/сутки  |
|--------------------|-----------------------------------|----------------------------------------|
| Cтатические файлы  | `15,21`                            | `80,196`                                |
| API                | `0,57`                            | `2,983`                                |

- Страница ленты и пина
  - html, js, css - 2 Мб
  - Допустим, что пользователь просматривает каждый 7й пин.
    Тогда, учитывая, что пин весит 2 Мб или 50 Мб (фото, видео) и 99% процентов пинов - фото, а также, что пользователь просматривает 50 пинов в день:
  
    Для страницы ленты:
    ```azure
    80,5 * 10^6 * ( 350 * (2 Мб * 0,99 + 0,01 * 50 Мб) + 2 Мб ) ≈ 65,23 Пб
    ```
    Для страницы пина:
    ```azure
    80,5 * 10^6 * ( 50 * 2 Мб * 0,99 + 0,01 * 50 Мб) * 2 Мб ≈ 14,92 Пб
    ```
- Страницы регистарции, авторизации, создания пина, создания доски
  - html, js, css - 1,5 Мб
    Тогда итоговое суточное потребление:
    
    ```azure
    1,5 Мб * (134,25*10^3 + 1,341*10^5 + 322*10^5 + 2,87*10^5) ≈ 0,046 Пб
    ```
- Создание пинов
  
    ```azure
    ( 50 * 2 Мб * 0,99 + 0,01 * 50 Мб) * 322 * 10^5 ≈ 2,98 Пб
    ```
- Комментирование
  
    ```azure
    300 б * 402,5 * 10^5 ≈ 0,000011 ПБ
    ```
- Регистрация
  
     ```azure
    2 Мб * 134,25 * 10^3 ≈ 0,00026 ПБ
    ```
     
- Допустим, что пиковое дневное потребление в 2 раза больше среднего [[10]](https://buffer.com/resources/pinterest-scheduling-frequency-timing/ )https://buffer.com/resources/pinterest-scheduling-frequency-timing/. Получим 160,392 Пб/день и 5,966 Пб/день => 15,21 Тбит/сек и 0,57 Тбит/сек


